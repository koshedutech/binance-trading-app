# Production Docker Compose Configuration
# Usage: docker-compose -f docker-compose.prod.yml up -d
# IMPORTANT: Edit the environment variables below before deploying!

services:
  # PostgreSQL Database with production settings
  postgres:
    image: postgres:15-alpine
    container_name: binance-bot-postgres-prod
    restart: always
    environment:
      - POSTGRES_USER=trading_bot
      - POSTGRES_PASSWORD=trading_bot_password
      - POSTGRES_DB=trading_bot
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - trading-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trading_bot"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Trading Bot - Production Mode
  trading-bot:
    image: binance-trading-bot:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance-trading-bot-prod
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Binance API - Keys are stored per-user in database
      - BINANCE_BASE_URL=https://fapi.binance.com
      - BINANCE_TESTNET=false
      - MOCK_MODE=false
      - TRADING_DRY_RUN=false
      # Database
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=trading_bot
      - DB_PASSWORD=trading_bot_password
      - DB_NAME=trading_bot
      - DB_SSLMODE=disable
      # Web Server (Production uses port 8095)
      - WEB_PORT=8095
      - WEB_HOST=0.0.0.0
      # Notifications (recommended for production)
      - NOTIFICATIONS_ENABLED=true
      - TELEGRAM_ENABLED=false
      - TELEGRAM_BOT_TOKEN=
      - TELEGRAM_CHAT_ID=
      - DISCORD_ENABLED=false
      - DISCORD_WEBHOOK_URL=
      # Logging - Production settings
      - LOG_LEVEL=INFO
      - LOG_OUTPUT=stdout
      - LOG_JSON=true
      - LOG_INCLUDE_FILE=false
      # AI Configuration
      - AI_ENABLED=true
      - AI_LLM_ENABLED=true
      - AI_ML_ENABLED=true
      - AI_SENTIMENT_ENABLED=true
      - AI_LLM_PROVIDER=deepseek
      - AI_LLM_MODEL=deepseek-chat
      - AI_MIN_CONFIDENCE=0.65
      # Futures Trading
      - FUTURES_ENABLED=true
      - FUTURES_TESTNET=false
      - FUTURES_DEFAULT_LEVERAGE=10
      - FUTURES_DEFAULT_MARGIN_TYPE=CROSSED
      - FUTURES_POSITION_MODE=ONE_WAY
      - FUTURES_MAX_LEVERAGE=125
      # Futures Autopilot
      - FUTURES_AUTOPILOT_ENABLED=true
      - FUTURES_AUTOPILOT_RISK_LEVEL=moderate
      - FUTURES_AUTOPILOT_MAX_DAILY_TRADES=50
      - FUTURES_AUTOPILOT_MAX_DAILY_LOSS=3.0
      - FUTURES_AUTOPILOT_MAX_POSITION_SIZE=5.0
      - FUTURES_AUTOPILOT_MIN_CONFIDENCE=0.35
      - FUTURES_AUTOPILOT_DEFAULT_LEVERAGE=5
      - FUTURES_AUTOPILOT_MAX_LEVERAGE=20
      # Circuit Breaker
      - CIRCUIT_BREAKER_ENABLED=true
      - CIRCUIT_MAX_LOSS_PER_HOUR=3.0
      - CIRCUIT_MAX_CONSECUTIVE_LOSSES=5
      - CIRCUIT_COOLDOWN_MINUTES=30
      # Authentication Configuration
      - AUTH_ENABLED=true
      - AUTH_JWT_SECRET=prod-jwt-secret-key-2025-binance-bot-secure
      - AUTH_REQUIRE_EMAIL_VERIFICATION=false
      - AUTH_ACCESS_TOKEN_DURATION=15m
      - AUTH_REFRESH_TOKEN_DURATION=168h
      # Subscription Configuration
      - SUBSCRIPTION_ENABLED=false
    volumes:
      - ./logs:/app/logs
      - ./config.json:/app/config.json:ro
      # BUG FIX: Persist Ginie state files across container restarts
      # Without this, scalp_reentry TP levels reset to TP1 on restart
      - ./ginie_position_state.json:/app/ginie_position_state.json
      - ./autopilot_settings.json:/app/autopilot_settings.json
    networks:
      - trading-network
    ports:
      - "8095:8095"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8095/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (optional, for SSL/domain)
  nginx:
    image: nginx:alpine
    container_name: binance-bot-nginx
    restart: always
    depends_on:
      - trading-bot
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - trading-network
    ports:
      - "80:80"
      - "443:443"
    profiles:
      - with-nginx

  # Database backup service
  backup:
    image: postgres:15-alpine
    container_name: binance-bot-backup
    depends_on:
      - postgres
    environment:
      - PGHOST=postgres
      - PGUSER=trading_bot
      - PGPASSWORD=trading_bot_password
      - PGDATABASE=trading_bot
    volumes:
      - ./backups:/backups
    networks:
      - trading-network
    entrypoint: /bin/sh
    command: >
      -c 'while true; do
        BACKUP_FILE="/backups/backup_$$(date +%Y%m%d_%H%M%S).sql";
        pg_dump > $$BACKUP_FILE;
        gzip $$BACKUP_FILE;
        find /backups -name "*.sql.gz" -mtime +7 -delete;
        echo "Backup completed: $$BACKUP_FILE.gz";
        sleep 86400;
      done'
    profiles:
      - with-backup

networks:
  trading-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
