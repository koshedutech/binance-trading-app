# Docker Compose Override for Oracle Cloud Deployment
# Usage: docker compose -f docker-compose.yml -f docker-compose.oracle.yml up -d
#
# This file provides production-optimized settings for Oracle Cloud Free Tier
# VM.Standard.A1.Flex (4 OCPUs, 24GB RAM, 200GB storage)

version: '3.8'

services:
  postgres:
    # PostgreSQL database service
    restart: always

    # Production volume mounts
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /opt/trading-bot/backups:/backups

    # Resource limits (out of 24GB total, allocate 2GB for DB)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Structured logging with rotation
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        labels: "service=postgres"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trading_bot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  trading-bot:
    # Main application service
    restart: always

    # Production volume mounts
    volumes:
      - /opt/trading-bot/logs:/app/logs
      - /opt/trading-bot/.env:/app/.env:ro
      - /opt/trading-bot/data:/app/data

    # Resource limits (out of 24GB total, allocate 4GB for app)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G

    # Structured logging with rotation (larger for app)
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=trading-bot"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "-O-", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Graceful shutdown
    stop_grace_period: 30s

    # Ensure database is ready before starting app
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/trading-bot/data/postgres
