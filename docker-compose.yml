services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: binance-bot-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=trading_bot
      - POSTGRES_PASSWORD=trading_bot_password
      - POSTGRES_DB=trading_bot
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trading_bot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Trading Bot with Web Interface (DEVELOPMENT)
  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: binance-trading-bot-dev
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Binance API - All API keys are per-user, stored in database via Settings UI
      # No global/environment API keys supported
      - BINANCE_BASE_URL=https://fapi.binance.com
      - BINANCE_TESTNET=false
      - MOCK_MODE=false
      - TRADING_DRY_RUN=false
      # Database
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=trading_bot
      - DB_PASSWORD=trading_bot_password
      - DB_NAME=trading_bot
      - DB_SSLMODE=disable
      # Web Server (Development uses port 8094)
      - WEB_PORT=8094
      - WEB_HOST=0.0.0.0
      # Notifications
      - NOTIFICATIONS_ENABLED=false
      - TELEGRAM_ENABLED=false
      - TELEGRAM_BOT_TOKEN=
      - TELEGRAM_CHAT_ID=
      - DISCORD_ENABLED=false
      - DISCORD_WEBHOOK_URL=
      # Logging
      - LOG_LEVEL=INFO
      - LOG_OUTPUT=stdout
      - LOG_JSON=true
      - LOG_INCLUDE_FILE=false
      # AI/ML Configuration
      - AI_ENABLED=true
      - AI_LLM_ENABLED=true
      - AI_ML_ENABLED=true
      - AI_SENTIMENT_ENABLED=true
      - AI_LLM_PROVIDER=deepseek
      - AI_LLM_MODEL=deepseek-chat
      - AI_MIN_CONFIDENCE=0.65
      # Autopilot Configuration
      - AUTOPILOT_ENABLED=false
      - AUTOPILOT_RISK_LEVEL=moderate
      - AUTOPILOT_MIN_CONFIDENCE=0.65
      - AUTOPILOT_MAX_DAILY_LOSS=5.0
      - AUTOPILOT_REQUIRE_MULTI_SIGNAL=true
      # Scalping Configuration
      - SCALPING_ENABLED=true
      - SCALPING_MIN_PROFIT=0.05
      - SCALPING_MAX_LOSS=0.1
      - SCALPING_MAX_HOLD_SECONDS=60
      # Big Candle Configuration
      - BIG_CANDLE_ENABLED=true
      - BIG_CANDLE_SIZE_MULTIPLIER=1.5
      - BIG_CANDLE_VOLUME_CONFIRMATION=true
      # Circuit Breaker Configuration
      - CIRCUIT_BREAKER_ENABLED=true
      - CIRCUIT_MAX_LOSS_PER_HOUR=3.0
      - CIRCUIT_MAX_CONSECUTIVE_LOSSES=5
      - CIRCUIT_COOLDOWN_MINUTES=30
      # Futures Trading Configuration
      - FUTURES_ENABLED=true
      - FUTURES_TESTNET=false
      - FUTURES_DEFAULT_LEVERAGE=10
      - FUTURES_DEFAULT_MARGIN_TYPE=CROSSED
      - FUTURES_POSITION_MODE=ONE_WAY
      - FUTURES_MAX_LEVERAGE=125
      # Futures Autopilot Configuration
      - FUTURES_AUTOPILOT_ENABLED=true
      - FUTURES_AUTOPILOT_RISK_LEVEL=moderate
      - FUTURES_AUTOPILOT_MAX_DAILY_TRADES=50
      - FUTURES_AUTOPILOT_MAX_DAILY_LOSS=3.0
      - FUTURES_AUTOPILOT_MAX_POSITION_SIZE=5.0
      - FUTURES_AUTOPILOT_MIN_CONFIDENCE=0.35
      - FUTURES_AUTOPILOT_REQUIRE_CONFLUENCE=1
      - FUTURES_AUTOPILOT_DEFAULT_LEVERAGE=5
      - FUTURES_AUTOPILOT_MAX_LEVERAGE=20
      - FUTURES_AUTOPILOT_MARGIN_TYPE=CROSSED
      - FUTURES_AUTOPILOT_POSITION_MODE=ONE_WAY
      - FUTURES_AUTOPILOT_ALLOW_SHORTS=true
      - FUTURES_AUTOPILOT_TAKE_PROFIT=2.0
      - FUTURES_AUTOPILOT_STOP_LOSS=1.0
      - FUTURES_AUTOPILOT_TRAILING_STOP_ENABLED=true
      - FUTURES_AUTOPILOT_TRAILING_STOP_PERCENT=0.5
      - FUTURES_AUTOPILOT_DECISION_INTERVAL=5
      - FUTURES_AUTOPILOT_ALLOWED_SYMBOLS=BTCUSDT,ETHUSDT
      # Authentication Configuration
      - AUTH_ENABLED=true
      - AUTH_JWT_SECRET=binance-trading-bot-jwt-secret-key-2025-change-in-prod
      - AUTH_REQUIRE_EMAIL_VERIFICATION=false
      - AUTH_ACCESS_TOKEN_DURATION=15m
      - AUTH_REFRESH_TOKEN_DURATION=168h
      # Subscription Configuration
      - SUBSCRIPTION_ENABLED=false
    volumes:
      # Mount source code for development (builds inside container)
      - .:/app
      # Exclude node_modules (use container's version)
      - /app/web/node_modules
      # Cache Go modules to avoid re-downloading
      - go-mod-cache:/go/pkg/mod
      # Cache Go build cache
      - go-build-cache:/root/.cache/go-build
      # Mount logs directory
      - ./logs:/app/logs
    ports:
      - "8094:8094"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8094/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres-data:
  go-mod-cache:
  go-build-cache:
